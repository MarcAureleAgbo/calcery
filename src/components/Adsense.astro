---
const isProd = import.meta.env.PROD;
const CONSENT_KEY = 'calcery_cookie_consent';
const ADSENSE_SRC =
  'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8558147642222882';
---

{
  isProd && (
    <script is:inline define:vars={{ CONSENT_KEY, ADSENSE_SRC }}>
      (() => {
        function loadAdsense() {
          if (window.__calceryAdsenseLoaded) return;

          const existing = document.querySelector(`script[src="${ADSENSE_SRC}"]`);
          if (existing) {
            window.__calceryAdsenseLoaded = true;
            return;
          }

          const script = document.createElement('script');
          script.async = true;
          script.src = ADSENSE_SRC;
          script.setAttribute('crossorigin', 'anonymous');
          document.head.appendChild(script);
          window.__calceryAdsenseLoaded = true;
        }

        function readConsent() {
          try {
            return localStorage.getItem(CONSENT_KEY);
          } catch {
            return null;
          }
        }

        if (readConsent() === 'accepted') {
          loadAdsense();
        }

        window.addEventListener('calcery:consent-updated', (event) => {
          const status = event?.detail?.status;
          if (status === 'accepted') {
            loadAdsense();
          }
        });
      })();
    </script>
  )
}
