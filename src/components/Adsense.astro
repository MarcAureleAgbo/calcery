---
const isProd = import.meta.env.PROD;
const CONSENT_KEY = 'calcery_cookie_consent';
const ADSENSE_CLIENT = 'ca-pub-8558147642222882';
const ADSENSE_SRC = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${ADSENSE_CLIENT}`;
---

{
  isProd && (
    <>
      <script async src={ADSENSE_SRC} crossorigin="anonymous"></script>
      <script is:inline define:vars={{ CONSENT_KEY }}>
        (() => {
          function hasAcceptedConsent() {
            try {
              return localStorage.getItem(CONSENT_KEY) === 'accepted';
            } catch {
              return false;
            }
          }

          function initializeAdsenseSlots() {
            if (!hasAcceptedConsent()) return;

            const slots = document.querySelectorAll('ins.adsbygoogle:not([data-calcery-adsense-initialized])');
            if (!slots.length) return;

            slots.forEach((slot) => {
              slot.setAttribute('data-calcery-adsense-initialized', 'true');
              try {
                (window.adsbygoogle = window.adsbygoogle || []).push({});
              } catch {
                slot.removeAttribute('data-calcery-adsense-initialized');
              }
            });
          }

          function onReady() {
            initializeAdsenseSlots();
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', onReady, { once: true });
          } else {
            onReady();
          }

          if (!window.__calceryAdsenseConsentListenerAttached) {
            window.addEventListener('calcery:consent-updated', (event) => {
              const status = event?.detail?.status;
              if (status === 'accepted') {
                initializeAdsenseSlots();
              }
            });
            window.__calceryAdsenseConsentListenerAttached = true;
          }
        })();
      </script>
    </>
  )
}
