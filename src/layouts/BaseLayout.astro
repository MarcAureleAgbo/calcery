---
import '../styles/global.css';
import SEO from '../components/SEO.astro';
import Analytics from '../components/Analytics.astro';
import Adsense from '../components/Adsense.astro';
import CookieBanner from '../components/CookieBanner.astro';
import { getLocaleFromPath, localizePath, switchLocalePath, stripLocalePrefix, type Locale } from '../lib/i18n';
import { SITE_URL } from '../lib/site';
import { getCalculatorRoute } from '../lib/calculator-taxonomy';

export interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  lang?: Locale;
  image?: string;
  seoType?: 'website' | 'article';
}

const {
  title = 'Calcery - Des calculateurs simples pour mieux gérer votre quotidien',
  description = 'Calculateurs simples et gratuits pour mieux gérer votre budget quotidien, sans inscription ni complications.',
  canonical,
  lang,
  image,
  seoType = 'website',
} = Astro.props;

const currentLocale = lang ?? getLocaleFromPath(Astro.url.pathname);
const normalizedPath = stripLocalePrefix(Astro.url.pathname).replace(/\/+$/, '') || '/';
const frSwitchPath = switchLocalePath(Astro.url.pathname, 'fr');
const enSwitchPath = switchLocalePath(Astro.url.pathname, 'en');
const siteUrl = SITE_URL;
const calculatorsLandingPath = currentLocale === 'en' ? '/en/finance' : '/fr/finance';

const t = {
  fr: {
    skipToContent: 'Aller au contenu principal',
    mainNavigation: 'Navigation principale',
    nav: {
      home: 'Accueil',
      calculators: 'Calculateurs',
      categories: 'Catégories',
      blog: 'Blog',
      about: 'À propos',
      contact: 'Contact',
    },
    languageSelector: 'Sélecteur de langue',
    openMenu: 'Ouvrir le menu',
    footer: {
      description: 'Des calculateurs simples et gratuits pour mieux gérer votre budget quotidien, sans inscription ni complications.',
      navigation: 'Navigation',
      popularTools: 'Outils populaires',
      legal: 'Légal',
      monthlyBudget: 'Budget mensuel',
      savings: 'Épargne',
      tip: 'Pourboire',
      investing: 'Investissement',
      legalNotice: 'Mentions légales',
      privacy: 'Politique de confidentialité',
      manageCookies: 'Gérer les cookies',
      rights: 'Tous les droits réservés.',
      madeForYou: 'Créé pour vous',
    },
    scrollTop: 'Retour en haut',
  },
  en: {
    skipToContent: 'Skip to main content',
    mainNavigation: 'Main navigation',
    nav: {
      home: 'Home',
      calculators: 'Calculators',
      categories: 'Categories',
      blog: 'Blog',
      about: 'About',
      contact: 'Contact',
    },
    languageSelector: 'Language selector',
    openMenu: 'Open menu',
    footer: {
      description: 'Simple and free calculators to better manage your daily budget, with no signup and no complications.',
      navigation: 'Navigation',
      popularTools: 'Popular Tools',
      legal: 'Legal',
      monthlyBudget: 'Monthly budget',
      savings: 'Savings',
      tip: 'Tip',
      investing: 'Investing',
      legalNotice: 'Legal notice',
      privacy: 'Privacy policy',
      manageCookies: 'Manage cookies',
      rights: 'All rights reserved.',
      madeForYou: 'Built for you',
    },
    scrollTop: 'Back to top',
  },
}[currentLocale];

const navItems = [
  { href: '/', label: t.nav.home },
  { href: calculatorsLandingPath, label: t.nav.calculators },
  { href: '/blog', label: t.nav.blog },
  { href: '/a-propos', label: t.nav.about },
  { href: '/contact', label: t.nav.contact },
];

const categoryLinks =
  currentLocale === 'en'
    ? [
        { href: '/en/finance', label: 'Finance' },
        { href: '/en/health', label: 'Health' },
        { href: '/en/real-estate', label: 'Real estate' },
        { href: '/en/daily-life', label: 'Daily life' },
        { href: '/en/home', label: 'Home' },
        { href: '/en/education', label: 'Education' },
      ]
    : [
        { href: '/fr/finance', label: 'Finance' },
        { href: '/fr/sante', label: 'Santé' },
        { href: '/fr/immobilier', label: 'Immobilier' },
        { href: '/fr/vie-pratique', label: 'Vie pratique' },
        { href: '/fr/maison-travaux', label: 'Maison & travaux' },
        { href: '/fr/education', label: 'Éducation' },
      ];

const withLocale = (href: string) => localizePath(href, currentLocale);

const isCalculatorCategoryPath =
  currentLocale === 'en'
    ? /^\/(finance|health|real-estate|daily-life|home|education)(\/|$)/.test(normalizedPath)
    : /^\/(finance|sante|immobilier|vie-pratique|maison-travaux|education)(\/|$)/.test(normalizedPath);

const isCurrentPath = (href: string) => {
  const normalizedHref = (stripLocalePrefix(href).replace(/\/+$/, '') || '/');
  const normalizedCalculatorHref = stripLocalePrefix(calculatorsLandingPath).replace(/\/+$/, '') || '/';
  if (normalizedHref === normalizedCalculatorHref && isCalculatorCategoryPath) return true;
  if (normalizedHref === '/') return normalizedPath === '/';
  return normalizedPath === normalizedHref || normalizedPath.startsWith(`${normalizedHref}/`);
};

const legalPagesWithHeaderOffset = new Set(['/mentions-legales', '/confidentialite', '/contact']);
const applyLegalHeaderOffset = legalPagesWithHeaderOffset.has(normalizedPath);
const applyMentionsHeroFix = normalizedPath === '/mentions-legales';
const applyAboutHeroFix = normalizedPath === '/a-propos';
---

<html lang={currentLocale}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/favicon-180x180.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/favicon-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/favicon-512x512.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="alternate" hreflang="fr" href={`${siteUrl}${frSwitchPath}`} />
    <link rel="alternate" hreflang="en" href={`${siteUrl}${enSwitchPath}`} />
    <link rel="alternate" hreflang="x-default" href={`${siteUrl}${frSwitchPath}`} />

    <SEO
      title={title}
      description={description}
      canonical={canonical}
      image={image}
      type={seoType}
      locale={currentLocale === 'en' ? 'en_US' : 'fr_FR'}
    />
    <Analytics />
    <Adsense />
  </head>

  <body class:list={{ 'legal-page-layout': applyLegalHeaderOffset, 'mentions-hero-fix': applyMentionsHeroFix, 'about-hero-fix': applyAboutHeroFix }}>
    <a href="#main-content" class="skip-link">{t.skipToContent}</a>

    <div class="animated-background" aria-hidden="true">
      <div class="dot-grid"></div>
      <div class="gradient-orb orb-1"></div>
      <div class="gradient-orb orb-2"></div>
      <div class="gradient-orb orb-3"></div>
      <div class="particles" id="particles"></div>
    </div>

    <header class="site-header" id="site-header">
      <nav class="site-nav" aria-label={t.mainNavigation}>
        <a href={withLocale('/')} class="logo">Calcery</a>

        <ul class="nav-links">
          {navItems.map((item) => (
            item.href === calculatorsLandingPath ? (
              <li class="nav-dropdown">
                <a
                  href={item.href}
                  class:list={{ 'is-active': isCurrentPath(item.href) }}
                  aria-current={isCurrentPath(item.href) ? 'page' : undefined}
                >
                  {item.label}
                </a>
                <div class="nav-dropdown-menu" aria-label={t.nav.categories}>
                  {categoryLinks.map((category) => (
                    <a
                      href={category.href}
                      class:list={{ 'is-active': isCurrentPath(category.href) }}
                      aria-current={isCurrentPath(category.href) ? 'page' : undefined}
                    >
                      {category.label}
                    </a>
                  ))}
                </div>
              </li>
            ) : (
              <li>
                <a
                  href={withLocale(item.href)}
                  class:list={{ 'is-active': isCurrentPath(item.href) }}
                  aria-current={isCurrentPath(item.href) ? 'page' : undefined}
                >
                  {item.label}
                </a>
              </li>
            )
          ))}
        </ul>

        <div class="ml-4">
          <label for="lang-select" class="sr-only">{t.languageSelector}</label>
          <select id="lang-select" class="border rounded-md px-2 py-1 text-sm" aria-label={t.languageSelector} data-fr-path={frSwitchPath} data-en-path={enSwitchPath}>
            <option value="fr">FR</option>
            <option value="en">EN</option>
          </select>
        </div>

        <button class="mobile-menu-btn" id="mobile-menu-btn" type="button" aria-label={t.openMenu} aria-controls="mobile-menu" aria-expanded="false">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </nav>

      <div class="mobile-menu" id="mobile-menu">
        {navItems.map((item) => (
          <a
            href={withLocale(item.href)}
            class:list={{ 'is-active': isCurrentPath(item.href) }}
            aria-current={isCurrentPath(item.href) ? 'page' : undefined}
          >
            {item.label}
          </a>
        ))}
        <div class="mobile-categories">
          <p class="mobile-categories-title">{t.nav.categories}</p>
          {categoryLinks.map((category) => (
            <a
              href={category.href}
              class:list={{ 'mobile-category-link': true, 'is-active': isCurrentPath(category.href) }}
              aria-current={isCurrentPath(category.href) ? 'page' : undefined}
            >
              {category.label}
            </a>
          ))}
        </div>
        <div class="p-4">
          <label for="lang-select-mobile" class="sr-only">{t.languageSelector}</label>
          <select id="lang-select-mobile" class="w-full border rounded-md px-2 py-1 text-sm" aria-label={t.languageSelector} data-fr-path={frSwitchPath} data-en-path={enSwitchPath}>
            <option value="fr">FR</option>
            <option value="en">EN</option>
          </select>
        </div>
      </div>
    </header>

    <main id="main-content" class:list={{ 'legal-main-offset': applyLegalHeaderOffset }}>
      <slot />
    </main>

    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-brand">
          <h3>Calcery</h3>
          <p>
            {t.footer.description}
          </p>
        </div>

        <div class="footer-section">
          <h4>{t.footer.navigation}</h4>
          <ul class="footer-links">
            <li><a href={withLocale('/')}>{t.nav.home}</a></li>
            <li><a href={calculatorsLandingPath}>{t.nav.calculators}</a></li>
            <li><a href={withLocale('/blog')}>{t.nav.blog}</a></li>
            <li><a href={withLocale('/a-propos')}>{t.nav.about}</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h4>{t.footer.popularTools}</h4>
          <ul class="footer-links">
            <li><a href={getCalculatorRoute(currentLocale, 'budget-mensuel')}>{t.footer.monthlyBudget}</a></li>
            <li><a href={getCalculatorRoute(currentLocale, 'epargne-automatique')}>{t.footer.savings}</a></li>
            <li><a href={getCalculatorRoute(currentLocale, 'pourboire')}>{t.footer.tip}</a></li>
            <li><a href={getCalculatorRoute(currentLocale, 'interets-composes')}>{t.footer.investing}</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h4>{t.footer.legal}</h4>
          <ul class="footer-links">
            <li><a href={withLocale('/mentions-legales')}>{t.footer.legalNotice}</a></li>
            <li><a href={withLocale('/confidentialite')}>{t.footer.privacy}</a></li>
            <li><a href={withLocale('/contact')}>{t.nav.contact}</a></li>
            <li>
              <button type="button" class="text-left hover:underline" data-cookie-settings>{t.footer.manageCookies}</button>
            </li>
          </ul>
        </div>
      </div>

      <div class="footer-bottom">
        <p>&copy; 2026 Maison Ellis. {t.footer.rights} | {t.footer.madeForYou}</p>
      </div>
    </footer>

    <button class="scroll-top" id="scroll-top" type="button" aria-label={t.scrollTop}>
      <svg width="24" height="24" fill="none" stroke="white" stroke-width="2.5" aria-hidden="true">
        <path d="M18 15l-6-6-6 6" />
      </svg>
    </button>
    <CookieBanner />

    <script define:vars={{ currentLocale }}>
      // Device detection
      const isMobile = /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

      // Generate particles according to the device
      function createParticles() {
        const container = document.getElementById('particles');
        if (!container) return;

        const count = isMobile ? 20 : 40;
        container.innerHTML = '';

        for (let i = 0; i < count; i += 1) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.animationDelay = `${Math.random() * 20}s`;
          particle.style.animationDuration = `${15 + Math.random() * 15}s`;
          container.appendChild(particle);
        }
      }

      createParticles();

      // Header scrolled + scroll-to-top button with RAF
      const header = document.getElementById('site-header');
      const scrollTop = document.getElementById('scroll-top');
      let scrollTicking = false;

      function updateOnScroll() {
        const y = window.pageYOffset;

        if (header) {
          if (y > 100) {
            header.classList.add('scrolled');
          } else {
            header.classList.remove('scrolled');
          }
        }

        if (scrollTop) {
          if (y > 400) {
            scrollTop.classList.add('visible');
          } else {
            scrollTop.classList.remove('visible');
          }
        }

        scrollTicking = false;
      }

      window.addEventListener('scroll', () => {
        if (!scrollTicking) {
          window.requestAnimationFrame(updateOnScroll);
          scrollTicking = true;
        }
      }, { passive: true });

      // Mobile menu
      const menuButton = document.getElementById('mobile-menu-btn');
      const mobileMenu = document.getElementById('mobile-menu');

      if (menuButton && mobileMenu) {
        menuButton.addEventListener('click', () => {
          const isOpen = mobileMenu.classList.toggle('open');
          menuButton.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });

        mobileMenu.querySelectorAll('a').forEach((link) => {
          link.addEventListener('click', () => {
            mobileMenu.classList.remove('open');
            menuButton.setAttribute('aria-expanded', 'false');
          });
        });
      }

      // Scroll back to top
      if (scrollTop) {
        scrollTop.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }

      document.querySelectorAll('[data-cookie-settings]').forEach((button) => {
        button.addEventListener('click', () => {
          window.dispatchEvent(new CustomEvent('calcery:open-cookie-banner'));
        });
      });

      // Progressive cards reveal on scroll
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const target = entry.target;
            target.style.opacity = '1';
            target.style.transform = 'translateY(0)';
          }
        });
      }, {
        threshold: isMobile ? 0.05 : 0.1,
        rootMargin: isMobile ? '0px 0px -50px 0px' : '0px 0px -100px 0px',
      });

      document.querySelectorAll('.tool-card, .feature-card, .step-card').forEach((card) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
      });

      // Language selector based on mirrored FR/EN routes
      function initLangSelector() {
        const selectors = [
          document.getElementById('lang-select'),
          document.getElementById('lang-select-mobile'),
        ].filter(Boolean);

        if (selectors.length === 0) return;

        const savedLocale = localStorage.getItem('site_lang');
        if ((savedLocale === 'fr' || savedLocale === 'en') && savedLocale !== currentLocale) {
          const refSelector = selectors[0];
          const targetPath = savedLocale === 'en' ? refSelector.dataset.enPath : refSelector.dataset.frPath;
          if (targetPath) {
            window.location.replace(`${targetPath}${window.location.search}`);
            return;
          }
        }

        selectors.forEach((sel) => {
          sel.value = currentLocale;
          sel.addEventListener('change', (e) => {
            const target = e.target.value;
            const frPath = sel.dataset.frPath || '/';
            const enPath = sel.dataset.enPath || '/en';
            const nextPath = target === 'en' ? enPath : frPath;
            localStorage.setItem('site_lang', target);
            window.location.href = `${nextPath}${window.location.search}`;
          });
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLangSelector);
      } else {
        initLangSelector();
      }

      // Touch feedback
      if (isTouch) {
        document.querySelectorAll('.tool-card, .btn, .feature-badge, .mobile-menu-btn').forEach((element) => {
          element.addEventListener('touchstart', function onTouchStart() {
            this.style.transform = 'scale(0.97)';
          }, { passive: true });

          element.addEventListener('touchend', function onTouchEnd() {
            this.style.transform = '';
          }, { passive: true });
        });
      }

      // Reduced animations on low battery
      if (navigator.getBattery) {
        navigator.getBattery().then((battery) => {
          if (!battery.charging && battery.level < 0.2) {
            document.body.classList.add('reduce-motion');
          }
        }).catch(() => {
          // Ignore gracefully in unsupported/blocked browsers.
        });
      }
    </script>
  </body>
</html>
