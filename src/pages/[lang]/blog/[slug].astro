---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Button from '../../../components/ui/Button.astro';
import Card from '../../../components/ui/Card.astro';
import { getCollection } from 'astro:content';
import { toAbsoluteUrl } from '../../../lib/site';
import { getCalculatorRoute } from '../../../lib/calculator-taxonomy';
import { FR_TO_EN_BLOG_SLUG, EN_TO_FR_BLOG_SLUG } from '../../../lib/blog-slug-map';

type Locale = 'fr' | 'en';
type CollectionName = 'blog' | 'blogEn';

export async function getStaticPaths() {
  const [frPosts, enPosts] = await Promise.all([getCollection('blog'), getCollection('blogEn')]);
  const frPublished = frPosts.filter((post) => !post.data.draft);
  const enPublished = enPosts.filter((post) => !post.data.draft);

  return [
    ...frPublished.map((post) => ({
      params: { lang: 'fr', slug: post.slug },
      props: { post, lang: 'fr', collectionName: 'blog' },
    })),
    ...enPublished.map((post) => ({
      params: { lang: 'en', slug: post.slug },
      props: { post, lang: 'en', collectionName: 'blogEn' },
    })),
  ];
}

const { post, lang, collectionName } = Astro.props as {
  post: Awaited<ReturnType<typeof getCollection<'blog'>>>[number] | Awaited<ReturnType<typeof getCollection<'blogEn'>>>[number];
  lang: Locale;
  collectionName: CollectionName;
};
const { Content } = await post.render();

const allPosts = await getCollection(collectionName);
const relatedPosts = allPosts.filter((p) => p.slug !== post.slug && !p.data.draft).slice(0, 2);
const readingTime = Math.max(1, Math.ceil(post.body.trim().split(/\s+/).length / 220));
const category = post.data.category ?? (lang === 'fr' ? 'Finance' : 'Finance');
const tags = post.data.tags ?? [];
const coverImage = post.data.coverImage ?? '/images/blog/default-cover.svg';
const coverAlt = post.data.coverAlt ?? post.data.title;
const publishedDate = post.data.pubDate ?? post.data.date;
const updatedDate = post.data.updatedDate ?? publishedDate;

if (!publishedDate) {
  throw new Error(`Missing publish date for post "${post.slug}".`);
}

const canonicalPath = `/${lang}/blog/${post.slug}/`;
const canonicalUrl = toAbsoluteUrl(canonicalPath);

const [frPosts, enPosts] = await Promise.all([getCollection('blog'), getCollection('blogEn')]);
const frTranslatedSlug = lang === 'en' ? (EN_TO_FR_BLOG_SLUG[post.slug] ?? post.slug) : post.slug;
const enTranslatedSlug = lang === 'fr' ? (FR_TO_EN_BLOG_SLUG[post.slug] ?? post.slug) : post.slug;
const hasFrVariant = frPosts.some((item) => !item.data.draft && item.slug === frTranslatedSlug);
const hasEnVariant = enPosts.some((item) => !item.data.draft && item.slug === enTranslatedSlug);
const frAlternatePath = hasFrVariant ? `/fr/blog/${frTranslatedSlug}/` : null;
const enAlternatePath = hasEnVariant ? `/en/blog/${enTranslatedSlug}/` : null;
const xDefaultAlternatePath = hasFrVariant
  ? frAlternatePath
  : hasEnVariant
    ? enAlternatePath
    : canonicalPath;

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  description: post.data.description,
  datePublished: new Date(publishedDate).toISOString(),
  dateModified: new Date(updatedDate ?? publishedDate).toISOString(),
  inLanguage: lang,
  url: canonicalUrl,
  image: toAbsoluteUrl(coverImage),
  author: {
    '@type': 'Organization',
    name: 'Calcery',
  },
  publisher: {
    '@type': 'Organization',
    name: 'Calcery',
    logo: {
      '@type': 'ImageObject',
      url: toAbsoluteUrl('/og.png'),
    },
  },
};

const fallbackFaqByLocale: Record<Locale, Array<{ question: string; answer: string }>> = {
  fr: [
    {
      question: 'Ce guide est-il adapté à un débutant ?',
      answer:
        'Oui. Le contenu est conçu pour être actionnable sans prérequis technique. Commencez avec un scénario simple puis affinez progressivement vos hypothèses.',
    },
    {
      question: 'Les résultats sont-ils garantis ?',
      answer:
        'Non. Les résultats dépendent toujours de vos données et de l’évolution de votre situation. Utilisez ces repères pour prendre des décisions plus claires, puis réévaluez régulièrement.',
    },
    {
      question: 'Peut-on utiliser ces méthodes sur mobile ?',
      answer:
        'Oui. Les articles et calculateurs Calcery sont consultables sur mobile et desktop, ce qui permet de comparer vos scénarios rapidement au quotidien.',
    },
  ],
  en: [
    {
      question: 'Is this guide suitable for beginners?',
      answer:
        'Yes. The content is designed to be practical without technical prerequisites. Start with a simple baseline and refine your assumptions over time.',
    },
    {
      question: 'Are the outcomes guaranteed?',
      answer:
        'No. Results always depend on your input values and changing context. Use these estimates to make better decisions and review them regularly.',
    },
    {
      question: 'Can I use these methods on mobile?',
      answer:
        'Yes. Calcery articles and tools are available on both mobile and desktop, making scenario checks easier in daily life.',
    },
  ],
};

const faqEntries = post.data.faq && post.data.faq.length > 0 ? post.data.faq : fallbackFaqByLocale[lang];
const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqEntries.map((item) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer,
    },
  })),
};

const isBudgetSlug = post.slug === 'methode-50-30-20' || post.slug === 'comment-faire-budget-mensuel-efficace';
const tools =
  lang === 'fr'
    ? isBudgetSlug
      ? [
          { href: getCalculatorRoute('fr', 'budget-mensuel'), title: 'Budget mensuel', desc: 'Équilibrez vos revenus et dépenses.' },
          { href: getCalculatorRoute('fr', 'epargne-automatique'), title: 'Épargne automatique', desc: "Atteignez vos objectifs d'épargne." },
          { href: getCalculatorRoute('fr', 'economies-petites-depenses'), title: 'Économies petites dépenses', desc: 'Réduisez vos petites habitudes coûteuses.' },
        ]
      : [
          { href: getCalculatorRoute('fr', 'economies-petites-depenses'), title: 'Économies petites dépenses', desc: "Calculez l'impact de vos petites dépenses." },
          { href: getCalculatorRoute('fr', 'budget-mensuel'), title: 'Budget mensuel', desc: 'Gérez votre budget global.' },
          { href: getCalculatorRoute('fr', 'epargne-automatique'), title: 'Épargne automatique', desc: 'Planifiez votre épargne.' },
        ]
    : isBudgetSlug
      ? [
          { href: getCalculatorRoute('en', 'budget-mensuel'), title: 'Monthly budget', desc: 'Balance income and expenses clearly.' },
          { href: getCalculatorRoute('en', 'epargne-automatique'), title: 'Automatic savings', desc: 'Plan recurring savings.' },
          { href: getCalculatorRoute('en', 'economies-petites-depenses'), title: 'Small expense savings', desc: 'Measure recurring small costs.' },
        ]
      : [
          { href: getCalculatorRoute('en', 'economies-petites-depenses'), title: 'Small expense savings', desc: 'Estimate recurring small expenses.' },
          { href: getCalculatorRoute('en', 'budget-mensuel'), title: 'Monthly budget', desc: 'Control your monthly cash flow.' },
          { href: getCalculatorRoute('en', 'epargne-automatique'), title: 'Automatic savings', desc: 'Build a realistic savings plan.' },
        ];

const listPath = `/${lang}/blog`;
const publishedLabel = lang === 'fr' ? 'Publié le' : 'Published on';
const readingLabel = lang === 'fr' ? 'min de lecture' : 'min read';
const authorLabel = lang === 'fr' ? 'Équipe Calcery' : 'Calcery Team';
const toolsTitle = lang === 'fr' ? 'Outils utiles' : 'Useful tools';
const toolButton = lang === 'fr' ? 'Utiliser' : 'Use tool';
const relatedTitle = lang === 'fr' ? 'Articles liés' : 'Related articles';
const relatedFallbackTitle = lang === 'fr' ? "Découvrez d'autres articles" : 'Explore more articles';
const relatedFallbackCta = lang === 'fr' ? 'Voir tous les articles' : 'View all articles';
const backLabel = lang === 'fr' ? 'Retour au blog' : 'Back to blog';
const homeLabel = lang === 'fr' ? 'Accueil' : 'Home';
const homePath = lang === 'fr' ? '/fr' : '/en';
const blogLabel = 'Blog';
const articleDateLine = `${publishedLabel} ${new Date(publishedDate).toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-US')}`;
const titleMatch = post.data.title.match(/^(.*?)\s*\((.+)\)$/);
const titlePrimary = titleMatch ? titleMatch[1] : post.data.title;
const titleSecondary = titleMatch ? titleMatch[2] : null;
---

<BaseLayout
  title={`${post.data.title} - Calcery`}
  description={post.data.description}
  canonical={canonicalPath}
  image={coverImage}
  seoType="article"
  lang={lang}
  alternatePaths={{ fr: frAlternatePath, en: enAlternatePath, xDefault: xDefaultAlternatePath }}
>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />

  <section class="section">
    <div class="mx-auto max-w-4xl px-4 py-16">
      <nav aria-label="Breadcrumb" class="mb-6 text-sm text-gray-500">
        <a href={homePath} class="hover:text-black">{homeLabel}</a>
        <span class="mx-2">&gt;</span>
        <a href={listPath} class="hover:text-black">{blogLabel}</a>
        <span class="mx-2">&gt;</span>
        <span class="text-gray-700">{post.data.title}</span>
      </nav>

      <article class="prose-lite max-w-none rounded-2xl border border-gray-200 bg-white/95 p-8 shadow-sm">
        <h1 class="mb-1 max-w-3xl text-3xl font-extrabold leading-tight tracking-tight text-gray-900 md:text-5xl">
          {titlePrimary}
          {titleSecondary && (
            <span class="mt-2 block text-base font-medium text-gray-500 md:text-xl">({titleSecondary})</span>
          )}
        </h1>
        <p class="mt-2 text-sm font-medium text-gray-500">{articleDateLine}</p>

        <figure class="article-cover">
          <img src={coverImage} alt={coverAlt} width="1200" height="630" loading="eager" decoding="async" />
        </figure>

        <p class="mb-4 text-lg text-gray-600">{post.data.description}</p>

        <div class="mb-8 flex flex-wrap items-center gap-3 text-sm text-gray-500">
          <span class="rounded-full border border-gray-200 bg-gray-50 px-3 py-1">{category}</span>
          <span class="rounded-full border border-gray-200 bg-gray-50 px-3 py-1">{publishedLabel} {new Date(publishedDate).toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-US')}</span>
          <span class="rounded-full border border-gray-200 bg-gray-50 px-3 py-1">{readingTime} {readingLabel}</span>
          <span class="rounded-full border border-gray-200 bg-gray-50 px-3 py-1">{authorLabel}</span>
        </div>

        {tags.length > 0 && (
          <div class="mb-8 flex flex-wrap gap-2">
            {tags.map((tag) => (
              <span class="rounded-full bg-black/5 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-gray-600">{tag}</span>
            ))}
          </div>
        )}

        <div class="article-body">
          <Content />
        </div>
      </article>
    </div>
  </section>

  <section class="section">
    <div class="mx-auto max-w-6xl px-4">
      <h2 class="mb-6 text-center text-2xl font-semibold">{toolsTitle}</h2>
      <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
        {tools.map((tool) => (
          <Card class="p-6 transition-shadow hover:shadow-md">
            <h3 class="mb-2 text-lg font-semibold"><a href={tool.href} class="text-black hover:underline">{tool.title}</a></h3>
            <p class="mb-4 text-gray-700">{tool.desc}</p>
            <Button href={tool.href} class="w-full">{toolButton}</Button>
          </Card>
        ))}
      </div>
    </div>
  </section>

  {relatedPosts.length > 0 ? (
    <section class="section">
      <div class="mx-auto max-w-6xl px-4">
        <h2 class="mb-6 text-center text-2xl font-semibold">{relatedTitle}</h2>
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
          {relatedPosts.map((related) => {
            const relatedDate = related.data.pubDate ?? related.data.date;
            return (
              <Card class="p-6 transition-shadow hover:shadow-md">
                <h3 class="mb-2 text-xl font-semibold"><a href={`/${lang}/blog/${related.slug}`} class="text-black hover:underline">{related.data.title}</a></h3>
                <p class="mb-4 text-gray-700">{related.data.description}</p>
                <p class="text-sm text-gray-500">{publishedLabel} {relatedDate ? new Date(relatedDate).toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-US') : ''}</p>
              </Card>
            );
          })}
        </div>
      </div>
    </section>
  ) : (
    <section class="section">
      <div class="mx-auto max-w-6xl px-4 text-center">
        <h2 class="mb-4 text-2xl font-semibold">{relatedFallbackTitle}</h2>
        <Button href={listPath}>{relatedFallbackCta}</Button>
      </div>
    </section>
  )}

  <section class="section pt-0">
    <div class="mx-auto max-w-6xl px-4 text-center">
      <a href={listPath} class="text-black hover:underline">{backLabel}</a>
    </div>
  </section>
</BaseLayout>
