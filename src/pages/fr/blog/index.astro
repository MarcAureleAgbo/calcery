---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Container from '../../../components/ui/Container.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog', (post) => !post.data.draft);
const sortedPosts = posts.sort((a, b) => {
  const aDate = a.data.pubDate ?? a.data.date;
  const bDate = b.data.pubDate ?? b.data.date;
  return new Date(bDate ?? 0).getTime() - new Date(aDate ?? 0).getTime();
});

const getReadingTime = (content: string) => {
  const words = content.trim().split(/\s+/).length;
  return Math.max(1, Math.ceil(words / 220));
};
---

<BaseLayout title="Blog - Calcery" description="Articles et conseils pratiques pour mieux gérer votre budget et votre épargne.">
  <section class="border-b border-gray-200/70 bg-gradient-to-b from-white via-gray-50/40 to-white py-20">
    <Container>
      <div class="mx-auto max-w-4xl text-center">
        <div class="mb-4 inline-flex rounded-full border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-700">Ressources Calcery</div>
        <h1 class="mb-4 text-5xl font-bold leading-tight text-gray-900 md:text-6xl">Articles et conseils</h1>
        <p class="text-xl font-light text-gray-600">Des contenus concrets pour mieux piloter votre budget, votre épargne et vos habitudes financières.</p>
      </div>
    </Container>
  </section>

  <section class="section">
    <div class="section-header">
      <div class="section-badge">Blog</div>
      <h2 class="section-title">Derniers articles</h2>
      <p class="section-subtitle">Des guides courts, actionnables, reliés à vos calculateurs préférés.</p>
    </div>

    <div class="grid grid-cols-1 gap-8 md:grid-cols-2">
      {sortedPosts.map((post) => {
        const readingTime = getReadingTime(post.body);
        const coverImage = post.data.coverImage ?? '/images/blog/default-cover.svg';
        const coverAlt = post.data.coverAlt ?? post.data.title;
        const category = post.data.category ?? 'Finance';
        const publishDate = post.data.pubDate ?? post.data.date;
        return (
          <article class="overflow-hidden rounded-2xl border border-gray-200 bg-white/90 shadow-sm transition-all hover:-translate-y-0.5 hover:border-gray-300 hover:shadow-md">
            <a href={`/fr/blog/${post.slug}`} class="block">
              <img
                src={coverImage}
                alt={coverAlt}
                width="1200"
                height="630"
                loading="lazy"
                decoding="async"
                class="h-52 w-full object-cover"
              />
            </a>

            <div class="p-8">
              <div class="mb-4 flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide text-gray-500">
                <span class="rounded-full border border-gray-200 bg-gray-50 px-3 py-1">{category}</span>
                <span>{readingTime} min</span>
              </div>

              <h3 class="mb-3 text-2xl font-bold text-black">
                <a href={`/fr/blog/${post.slug}`} class="transition-colors hover:text-gray-700">{post.data.title}</a>
              </h3>

              <p class="mb-6 line-clamp-3 leading-relaxed text-gray-700">{post.data.description}</p>

              <div class="flex items-center justify-between">
                <p class="text-sm text-gray-500">Publié le <span class="font-medium">{publishDate ? new Date(publishDate).toLocaleDateString('fr-FR') : ''}</span></p>
                <a href={`/fr/blog/${post.slug}`} class="inline-flex items-center gap-1 font-semibold text-black transition-all hover:gap-2">
                  Lire
                  <span aria-hidden="true">→</span>
                </a>
              </div>
            </div>
          </article>
        );
      })}
    </div>
  </section>
</BaseLayout>
