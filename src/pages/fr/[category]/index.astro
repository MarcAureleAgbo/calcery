---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Container from '../../../components/ui/Container.astro';
import ToolCard from '../../../components/ToolCard.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import {
  getCategoryStaticPaths,
  getCategoryRoute,
  getCalculatorRoute,
  type CategoryDefinition,
  type CalculatorDefinition,
} from '../../../lib/calculator-taxonomy';
import type { BreadcrumbItem } from '../../../lib/types';

export function getStaticPaths() {
  return getCategoryStaticPaths('fr');
}

interface Props {
  category: CategoryDefinition;
  calculators: CalculatorDefinition[];
}

const { category, calculators } = Astro.props as Props;

const breadcrumbs: BreadcrumbItem[] = [
  { name: 'Accueil', item: '/' },
  { name: category.name.fr, item: getCategoryRoute('fr', category.key) },
];

const primaryCtaHref = calculators.length
  ? getCalculatorRoute('fr', calculators[0].slug)
  : getCategoryRoute('fr', 'finance');

const summarizeParagraph = (text: string, maxSentences = 2) => {
  const sentences = text
    .split('. ')
    .map((sentence) => sentence.trim())
    .filter(Boolean);
  if (sentences.length === 0) return '';
  if (sentences.length <= maxSentences) return text;
  const summary = sentences.slice(0, maxSentences).join('. ');
  return summary.endsWith('.') ? summary : `${summary}.`;
};

const introParagraph = summarizeParagraph(category.seoText.fr[0] ?? '', 2);
const contextParagraph = summarizeParagraph(category.seoText.fr[1] ?? '', 1);
const highlights = calculators.length > 0
  ? calculators
      .slice(0, 4)
      .map((calculator) => `${calculator.name.fr} : ${calculator.description.fr}`)
  : category.seoText.fr.slice(0, 3).map((paragraph) => summarizeParagraph(paragraph, 1));
---

<BaseLayout
  title={category.title.fr}
  description={category.description.fr}
>
  <section class="border-b border-gray-200/70 bg-gradient-to-b from-white via-gray-50/40 to-white py-16">
    <Container>
      <div class="mx-auto max-w-5xl">
        <Breadcrumbs items={breadcrumbs} />

        <div class="mt-6 text-center">
          <div class="mb-4 inline-flex rounded-full border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-700">Categorie</div>
          <h1 class="mb-4 text-4xl font-bold leading-tight text-black md:text-6xl">{category.h1.fr}</h1>
          <p class="mx-auto max-w-3xl text-lg font-light text-gray-600 md:text-xl">{category.description.fr}</p>
        </div>
      </div>
    </Container>
  </section>

  <section class="section">
    <div class="section-header">
      <div class="section-badge">Guide rapide</div>
      <h2 class="section-title">L'essentiel de la categorie {category.name.fr}</h2>
      <p class="section-subtitle">Une vue courte et claire avant de choisir votre calculateur.</p>
    </div>

    <div class="mx-auto grid max-w-5xl gap-6 lg:grid-cols-[1.35fr_1fr]">
      <article class="rounded-2xl border border-gray-200/90 bg-white/95 p-8 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-900">Vue d'ensemble</h3>
        {introParagraph && <p class="mt-4 leading-relaxed text-gray-700">{introParagraph}</p>}
        {contextParagraph && <p class="mt-3 leading-relaxed text-gray-600">{contextParagraph}</p>}
      </article>

      <aside class="rounded-2xl border border-gray-200/90 bg-white/95 p-6 shadow-sm">
        <h3 class="text-lg font-semibold text-gray-900">Points cles</h3>
        <ul class="mt-4 space-y-3">
          {highlights.map((point) => (
            <li class="rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm leading-relaxed text-gray-700">{point}</li>
          ))}
        </ul>
      </aside>
    </div>
  </section>

  <section class="section">
    <div class="section-header">
      <div class="section-badge">Outils</div>
      <h2 class="section-title">Calculateurs de la categorie</h2>
      <p class="section-subtitle">Accedez rapidement aux outils disponibles pour cette thematique.</p>
    </div>

    {calculators.length > 0 ? (
      <div class="tools-grid">
        {calculators.map((calculator) => (
          <ToolCard
            icon={calculator.icon}
            title={calculator.name.fr}
            description={calculator.description.fr}
            href={getCalculatorRoute('fr', calculator.slug)}
          />
        ))}
      </div>
    ) : (
      <div class="mx-auto max-w-3xl rounded-2xl border border-dashed border-gray-300 bg-white/90 p-8 text-center text-gray-700">
        <p class="text-lg font-medium">Cette categorie est en cours de lancement.</p>
        <p class="mt-2">De nouveaux calculateurs seront publies ici prochainement.</p>
      </div>
    )}

    <div class="mt-8 text-center">
      <a href={primaryCtaHref} class="btn btn-primary inline-flex">{category.ctaLabel.fr}</a>
    </div>
  </section>
</BaseLayout>
